<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>CookieBites</title>
    <link rel="icon" href="img/galletitafavicon.ico" type="/x-icon" />
    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Dongle&display=swap"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Hedvig+Letters+Sans&display=swap"
      rel="stylesheet"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>
  <body>
    <header>
      <img
        id="logo"
        src="img/CookieBitesSinFondo.png"
        alt="Logo CookieBites"
        class="logo"
      />
      <div class="icons">
        <img src="img/usuario.png" alt="Crear cuenta" class="usuario" />
      </div>
    </header>
    <main>
      <button id="boton-volver">Volver</button>
      <h2>Factura Generada</h2>
      <div class="contenedor-pdf">
        <iframe id="pdfPreview" title="Vista previa del PDF"></iframe>
        <button class="button button1" id="botonvisu" onclick="generatePDF()">
          Visualizar Factura
        </button>
        <button class="button button1" id="botondownload">Descargar</button>
      </div>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
      <script>
        let urlParams = new URLSearchParams(window.location.search);
        let tipoDeUsuario = urlParams.get("perfil");
        let nombreUsuario = urlParams.get("id");

        document
          .getElementById("boton-volver")
          .addEventListener("click", () => {
            window.location.href =
              "ConsultarCatalogo.html?perfil=" +
              tipoDeUsuario +
              "&id=" +
              nombreUsuario;
          });

        const botonDesactivable = document.getElementById("botondownload");
        botonDesactivable.disabled = true;

        function generatePDF() {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();

          //const imgurl =

          // Recuperar datos del pedido y pago
          const nombre = localStorage.getItem("nombreCliente") || "";
          const fecha = localStorage.getItem("fechaEntrega") || "";
          const direccion = localStorage.getItem("direccionEntrega") || "";
          const nrorefe = localStorage.getItem("nroReferencia") || "";
          const productos = JSON.parse(
            localStorage.getItem("carritoPedido") || "[]"
          );
          const total = localStorage.getItem("totalPedido") || "0.00";
          const titular = localStorage.getItem("titularPago") || "";
          const banco = localStorage.getItem("bancoPago") || "";
          const celular = localStorage.getItem("celularPago") || "";
          const cedula = localStorage.getItem("cedulaPago") || "";

          doc.setFont("Times New Roman", "bold");
          doc.setFontSize(20);
          doc.text("Factura", 20, 45);
          doc.setFont("Times New Roman", "italicbold");
          doc.setFontSize(14);
          doc.text("Fecha:", 30, 55);
          doc.text(fecha, 60, 55);
          doc.text("Nombre:", 30, 60);
          doc.text(nombre, 60, 60);
          doc.text("Dirección:", 30, 65);
          doc.text(direccion, 60, 65);
          doc.text("Referencia:", 30, 70);
          doc.text(nrorefe, 60, 70);
          doc.text("Titular Pago:", 30, 75);
          doc.text(titular, 60, 75);
          doc.text("Banco:", 30, 80);
          doc.text(banco, 60, 80);
          doc.text("Cédula:", 30, 85);
          doc.text(cedula, 60, 85);
          doc.text("Celular:", 30, 90);
          doc.text(celular, 60, 90);

          doc.setFont("Times New Roman", "bold");
          doc.setFontSize(20);
          doc.text("Resumen de Compra:", 20, 100);
          doc.setFont("Times New Roman", "italicbold");
          doc.setFontSize(12);

          let y = 105;
          productos.forEach((prod) => {
            // Si tus productos son objetos simples, ajusta aquí:
            // doc.text(prod.nombreProducto, 30, y);
            // doc.text(`Cantidad: ${prod.cantidad}`, 100, y);
            // doc.text(`Precio: $${prod.precio}`, 150, y);

            // Si tus productos son objetos con 'producto' anidado:
            if (prod.producto) {
              doc.text(prod.producto.nombre, 30, y);
              doc.text(`Cantidad: ${prod.cantidad}`, 100, y);
              doc.text(`Precio: $${prod.producto.precio}`, 150, y);
            } else {
              doc.text(prod.nombreProducto || "Producto", 30, y);
              doc.text(`Cantidad: ${prod.cantidad}`, 100, y);
              doc.text(`Precio: $${prod.precio || "?"}`, 150, y);
            }
            y += 5;
          });

          doc.setFont("Times New Roman", "bold");
          doc.setFontSize(16);
          doc.text("TOTAL", 20, y + 5);
          doc.text(`$${Number(total).toFixed(2)}`, 60, y + 5);

          doc.setFontSize(14);
          doc.setFont("Times New Roman", "normal");
          doc.text("© CookieBites", 160, y + 20);

          const pdfBlob = doc.output("blob");
          const pdfUrl = URL.createObjectURL(pdfBlob);

          const iframe = document.getElementById("pdfPreview");
          // Libera el blob anterior si existe
          if (iframe.src) {
            URL.revokeObjectURL(iframe.src);
          }
          iframe.src = pdfUrl;
          botonDesactivable.disabled = false;

          botonDesactivable.onclick = function () {
            if (!botonDesactivable.disabled) {
              doc.save("factura.pdf");
            }
          };
        }

        // // Opcional: genera la factura automáticamente al cargar la página
        // generatePDF();
      </script>
    </main>
    <footer>
      <p>© CookieBites</p>
    </footer>
  </body>
</html>
